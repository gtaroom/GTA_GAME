name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Repository Name
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and Push Images
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/backend:latest
            ghcr.io/${{ env.REPO_LOWER }}/backend:${{ github.sha }}
          build-args: |
            MAXMIND_LICENSE_KEY=${{ secrets.MAXMIND_LICENSE_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Client
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/client:latest
            ghcr.io/${{ env.REPO_LOWER }}/client:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_IMAGE_URL=${{ secrets.NEXT_PUBLIC_IMAGE_URL }}
            NEXT_PUBLIC_VERIFF_API_KEY=${{ secrets.NEXT_PUBLIC_VERIFF_API_KEY }}
            NEXT_PUBLIC_PRODUCT_ID=${{ secrets.NEXT_PUBLIC_PRODUCT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Admin
        uses: docker/build-push-action@v5
        with:
          context: ./admin
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/admin:latest
            ghcr.io/${{ env.REPO_LOWER }}/admin:${{ github.sha }}
          build-args: |
            VITE_APP_API_URL=${{ secrets.VITE_APP_API_URL }}
            VITE_SERVER_URI=${{ secrets.VITE_SERVER_URI }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "placeholder"
          if_key_exists: replace
          config: |
            Host production
              HostName ${{ secrets.SSH_HOST }}
              User ${{ secrets.SSH_USER }}
              Port ${{ secrets.SSH_PORT || 22 }}
              StrictHostKeyChecking no

      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            # Use home-based app directory to avoid permission issues
            mkdir -p ~/app
            cd ~/app

            echo "Installing Standalone Docker Compose V2..."
            curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 -o docker-compose
            chmod +x docker-compose

            echo "Generating Clean docker-compose.prod.yml..."
            # Using direct interpolation for Repo/Tag to avoid shell expansion bugs
            cat <<EOF_COMPOSE | sed 's/^            //' > docker-compose.prod.yml
            services:
              mongodb:
                image: mongo:latest
                container_name: mongodb
                command: mongod --auth
                restart: always
                ports:
                  - "127.0.0.1:27017:27017"
                volumes:
                  - mongodb_data:/data/db
                deploy:
                  resources:
                    limits:
                      memory: 1024M

              backend:
                image: ghcr.io/${{ env.REPO_LOWER }}/backend:${{ github.sha }}
                restart: always
                env_file: .env
                environment:
                  - NODE_ENV=production
                  - PORT=3500
                ports:
                  - "3500:3500"
                volumes:  
                  - ./uploads:/app/uploads
                deploy:
                  resources:
                    limits:
                      cpus: '0.50'
                      memory: 1024M
                    reservations:
                      cpus: '0.25'
                      memory: 256M

              client:
                image: ghcr.io/${{ env.REPO_LOWER }}/client:${{ github.sha }}
                restart: always
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                ports:
                  - "3000:3000"
                deploy:
                  resources:
                    limits:
                      cpus: '0.50'
                      memory: 1024M
                    reservations:
                      cpus: '0.25'
                      memory: 512M

              admin:
                image: ghcr.io/${{ env.REPO_LOWER }}/admin:${{ github.sha }}
                restart: always
                ports:
                  - "5173:80"
                deploy:
                  resources:
                    limits:
                      cpus: '0.25'
                      memory: 256M
                    reservations:
                      cpus: '0.10'
                      memory: 128M

            volumes:
              mongodb_data:
            EOF_COMPOSE

            echo "Injecting environment variables..."
            # Using cat <<'EOF' with sed to strip ALL leading AND trailing whitespace
            # This ensures the .env file is clean and works with Docker
            # Standardize and secure environment variables
            cat <<'EOF_ENV_FILE' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > .env
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            ORIGINS=${{ secrets.ORIGINS }}
            DOMAIN=${{ secrets.DOMAIN }}
            EXPRESS_SESSION_SECRET=${{ secrets.EXPRESS_SESSION_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
            ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
            EZTEXTING_API_KEY=${{ secrets.EZTEXTING_API_KEY }}
            EZTEXTING_API_SECRET=${{ secrets.EZTEXTING_API_SECRET }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            ACCESS_TOKEN_EXPIRY=${{ secrets.ACCESS_TOKEN_EXPIRY }}
            REFRESH_TOKEN_EXPIRY=${{ secrets.REFRESH_TOKEN_EXPIRY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_CLIENT_CALLBACK_URI=${{ secrets.GOOGLE_CLIENT_CALLBACK_URI }}
            CLIENT_SSO_REDIRECT_URL=${{ secrets.CLIENT_SSO_REDIRECT_URL }}
            FORGOT_PASSWORD_REDIRECT_URL=${{ secrets.FORGOT_PASSWORD_REDIRECT_URL }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            WEBHOOK_CALLBACK_URL=${{ secrets.WEBHOOK_CALLBACK_URL }}
            PLISIO_API_KEY=${{ secrets.PLISIO_API_KEY }}
            SOAP_API_KEY=${{ secrets.SOAP_API_KEY }}
            SOAP_WEBHOOK_SECRET=${{ secrets.SOAP_WEBHOOK_SECRET }}
            SOAP_RETURN_URL=${{ secrets.SOAP_RETURN_URL }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            NOWPAYMENTS_API_KEY=${{ secrets.NOWPAYMENTS_API_KEY }}
            TWILIO_MESSAGING_SERVICE_SID=${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}
            TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
            TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
            TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
            GOAT_PAYMENTS_USERNAME=${{ secrets.GOAT_PAYMENTS_USERNAME }}
            GOAT_PAYMENTS_PASSWORD=${{ secrets.GOAT_PAYMENTS_PASSWORD }}
            CENTRYOS_API_KEY=${{ secrets.CENTRYOS_API_KEY }}
            CENTRYOS_WEBHOOK_SECRET=${{ secrets.CENTRYOS_WEBHOOK_SECRET }}
            CENTRYOS_RETURN_URL=${{ secrets.CENTRYOS_RETURN_URL }}
            CENTRYOS_ACCESS_TOKEN=${{ secrets.CENTRYOS_ACCESS_TOKEN }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
            PORT=3500
            EOF_ENV_FILE

            echo "Environment file generated. Line count: $(wc -l < .env)"
            echo "--- DEBUG: .env Keys and Value Lengths ---"
            while IFS='=' read -r key value; do
              echo "$key length: ${#value}"
            done < .env
            echo "---------------------------------------"

            echo "Pulling images..."
            # Explicit login just in case
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            ./docker-compose -f docker-compose.prod.yml pull

            echo "Clearing port conflicts..."
            for port in 80 443 3000 3500 5173; do
              (sudo fuser -k $port/tcp || true) 2>/dev/null
            done

            echo "Cleaning up old proxy containers..."
            docker stop nginx-proxy nginx-proxy-acme || true
            docker rm nginx-proxy nginx-proxy-acme || true

            echo "Deploying..."
            ./docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

            echo "Cleaning up..."
            rm docker-compose
            docker image prune -af

            echo "Deployment successful! Files are in ~/app"
