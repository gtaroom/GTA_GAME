name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Repository Name
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and Push Images
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/backend:latest
            ghcr.io/${{ env.REPO_LOWER }}/backend:${{ github.sha }}
          build-args: |
            MAXMIND_LICENSE_KEY=${{ secrets.MAXMIND_LICENSE_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Client
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/client:latest
            ghcr.io/${{ env.REPO_LOWER }}/client:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_IMAGE_URL=${{ secrets.NEXT_PUBLIC_IMAGE_URL }}
            NEXT_PUBLIC_VERIFF_API_KEY=${{ secrets.NEXT_PUBLIC_VERIFF_API_KEY }}
            NEXT_PUBLIC_PRODUCT_ID=${{ secrets.NEXT_PUBLIC_PRODUCT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Admin
        uses: docker/build-push-action@v5
        with:
          context: ./admin
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/admin:latest
            ghcr.io/${{ env.REPO_LOWER }}/admin:${{ github.sha }}
          build-args: |
            VITE_APP_API_URL=${{ secrets.VITE_APP_API_URL }}
            VITE_SERVER_URI=${{ secrets.VITE_SERVER_URI }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "placeholder"
          if_key_exists: replace
          config: |
            Host production
              HostName ${{ secrets.SSH_HOST }}
              User ${{ secrets.SSH_USER }}
              Port ${{ secrets.SSH_PORT || 22 }}
              StrictHostKeyChecking no

      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            # Use home-based app directory to avoid permission issues
            mkdir -p ~/app
            cd ~/app

            echo "Installing Standalone Docker Compose V2..."
            curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 -o docker-compose
            chmod +x docker-compose

            # 0. Backup CURRENT Stable Config (Critical: Must happen BEFORE generation)
            echo "Backing up current stable configuration..."
            if [ -f docker-compose.prod.yml ]; then
              cp docker-compose.prod.yml docker-compose.prod.yml.bak
              cp .env .env.bak
              BACKUP_EXISTS=true
            else
              BACKUP_EXISTS=false
            fi
            curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 -o docker-compose
            chmod +x docker-compose

            echo "Generating Clean docker-compose.prod.yml..."
            # Using direct interpolation for Repo/Tag to avoid shell expansion bugs
            cat <<EOF_COMPOSE | sed 's/^            //' > docker-compose.prod.yml
            services:
              mongodb:
                image: mongo:latest
                container_name: mongodb
                command: mongod --auth --wiredTigerCacheSizeGB 0.5 --quiet
                restart: always
                ports:
                  - "127.0.0.1:27017:27017"
                volumes:
                  - mongodb_data:/data/db
                deploy:
                  resources:
                    limits:
                      cpus: '0.60'
                      memory: 1024M
                    reservations:
                      cpus: '0.20'
                      memory: 512M

              backend:
                image: ghcr.io/${{ env.REPO_LOWER }}/backend:${{ github.sha }}
                restart: always
                env_file: .env
                environment:
                  - NODE_ENV=production
                  - PORT=3500
                  - UV_THREADPOOL_SIZE=4
                ports:
                  - "3500:3500"
                volumes:  
                  - /app/public:/app/public 
                  - /app/public/games:/app/public/games
                  - /app/public/game:/app/public/game
                  - /app/public/GeoLite2-City.mmdb:/app/public/GeoLite2-City.mmdb
                deploy:
                  resources:
                    limits:
                      cpus: '0.80'
                      memory: 1536M
                    reservations:
                      cpus: '0.30'
                      memory: 512M

              client:
                image: ghcr.io/${{ env.REPO_LOWER }}/client:${{ github.sha }}
                restart: always
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                ports:
                  - "3000:3000"
                deploy:
                  resources:
                    limits:
                      cpus: '0.50'
                      memory: 1024M
                    reservations:
                      cpus: '0.15'
                      memory: 256M

              admin:
                image: ghcr.io/${{ env.REPO_LOWER }}/admin:${{ github.sha }}
                restart: always
                ports:
                  - "5173:80"
                deploy:
                  resources:
                    limits:
                      cpus: '0.25'
                      memory: 256M
                    reservations:
                      cpus: '0.05'
                      memory: 128M

            volumes:
              mongodb_data:
            EOF_COMPOSE

            echo "Injecting environment variables..."
            # Using cat <<'EOF' with sed to strip ALL leading AND trailing whitespace
            # This ensures the .env file is clean and works with Docker
            # Standardize and secure environment variables
            cat <<'EOF_ENV_FILE' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > .env
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            ORIGINS=${{ secrets.ORIGINS }}
            DOMAIN=${{ secrets.DOMAIN }}
            EXPRESS_SESSION_SECRET=${{ secrets.EXPRESS_SESSION_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
            ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
            EZTEXTING_API_KEY=${{ secrets.EZTEXTING_API_KEY }}
            EZTEXTING_API_SECRET=${{ secrets.EZTEXTING_API_SECRET }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            ACCESS_TOKEN_EXPIRY=${{ secrets.ACCESS_TOKEN_EXPIRY }}
            REFRESH_TOKEN_EXPIRY=${{ secrets.REFRESH_TOKEN_EXPIRY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_CLIENT_CALLBACK_URI=${{ secrets.GOOGLE_CLIENT_CALLBACK_URI }}
            CLIENT_SSO_REDIRECT_URL=${{ secrets.CLIENT_SSO_REDIRECT_URL }}
            FORGOT_PASSWORD_REDIRECT_URL=${{ secrets.FORGOT_PASSWORD_REDIRECT_URL }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            WEBHOOK_CALLBACK_URL=${{ secrets.WEBHOOK_CALLBACK_URL }}
            PLISIO_API_KEY=${{ secrets.PLISIO_API_KEY }}
            SOAP_API_KEY=${{ secrets.SOAP_API_KEY }}
            SOAP_WEBHOOK_SECRET=${{ secrets.SOAP_WEBHOOK_SECRET }}
            SOAP_RETURN_URL=${{ secrets.SOAP_RETURN_URL }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            NOWPAYMENTS_API_KEY=${{ secrets.NOWPAYMENTS_API_KEY }}
            TWILIO_MESSAGING_SERVICE_SID=${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}
            TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
            TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
            TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
            GOAT_PAYMENTS_USERNAME=${{ secrets.GOAT_PAYMENTS_USERNAME }}
            GOAT_PAYMENTS_PASSWORD=${{ secrets.GOAT_PAYMENTS_PASSWORD }}
            CENTRYOS_API_KEY=${{ secrets.CENTRYOS_API_KEY }}
            CENTRYOS_WEBHOOK_SECRET=${{ secrets.CENTRYOS_WEBHOOK_SECRET }}
            CENTRYOS_RETURN_URL=${{ secrets.CENTRYOS_RETURN_URL }}
            CENTRYOS_ACCESS_TOKEN=${{ secrets.CENTRYOS_ACCESS_TOKEN }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
            PORT=3500
            EOF_ENV_FILE

            echo "Environment file generated. Line count: $(wc -l < .env)"
            echo "--- DEBUG: .env Keys and Value Lengths ---"
            while IFS='=' read -r key value; do
              echo "$key length: ${#value}"
            done < .env
            echo "---------------------------------------"

            echo "Pulling images..."
            # Explicit login just in case
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            ./docker-compose -f docker-compose.prod.yml pull

            echo "Fixing permissions for static assets..."
            # Ensure host directories exist and are readable (using absolute paths)
            mkdir -p /app/uploads /app/public/games /app/public/game

            # [AUTO-FIX] Detect and fix nested "games/games" folder from manual user copy errors
            if [ -d /app/public/games/games ]; then
              echo "Fixing nested /app/public/games/games directory..."
              # Copy contents up one level, ignoring errors if files exist
              cp -rf /app/public/games/games/* /app/public/games/ || true
              # Remove the now-redundant nested directory
              rm -rf /app/public/games/games
              echo "Fixed: Images moved to /app/public/games/"
            fi

            # Create placeholder for GeoLite2 DB to prevent Docker from creating a directory
            if [ ! -f /app/public/GeoLite2-City.mmdb ]; then
              touch /app/public/GeoLite2-City.mmdb
            fi

            # Create custom error page if it doesn't exist (it should be copied via SCP later, but for now strict copy)
            cat <<EOF_HTML > /app/public/custom_50x.html
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>GTO Arcade - Maintenance</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                        background-color: #0f172a;
                        color: #e2e8f0;
                        height: 100vh;
                        margin: 0;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                    }
                    .container {
                        max-width: 600px;
                        padding: 2rem;
                    }
                    h1 {
                        font-size: 2.5rem;
                        margin-bottom: 1rem;
                        background: linear-gradient(to right, #60a5fa, #a78bfa);
                        -webkit-background-clip: text;
                        background-clip: text;
                        -webkit-text-fill-color: transparent;
                    }
                    p {
                        font-size: 1.1rem;
                        line-height: 1.6;
                        color: #94a3b8;
                        margin-bottom: 2rem;
                    }
                    .spinner {
                        width: 40px;
                        height: 40px;
                        margin: 0 auto 2rem;
                        border: 3px solid #1e293b;
                        border-top: 3px solid #60a5fa;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="spinner"></div>
                    <h1>System Update in Progress</h1>
                    <p>We are currently deploying improvements to GTO Arcade. <br>The servers will be back online shortly.</p>
                    <p style="font-size: 0.9rem; opacity: 0.7;">Error Code: 502 Bad Gateway</p>
                </div>
                <script>
                    // Auto-reload every 30 seconds to check if the site is back
                    setTimeout(() => {
                        window.location.reload();
                    }, 30000);
                </script>
            </body>
            </html>
            EOF_HTML

            # Create custom 404 page
            cat <<EOF_HTML_404 > /app/public/custom_404.html
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>GTO Arcade - Page Not Found</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                        background-color: #0f172a;
                        color: #e2e8f0;
                        height: 100vh;
                        margin: 0;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                    }
                    .container {
                        max-width: 600px;
                        padding: 2rem;
                    }
                    h1 {
                        font-size: 6rem;
                        margin: 0;
                        line-height: 1;
                        background: linear-gradient(to right, #60a5fa, #a78bfa);
                        -webkit-background-clip: text;
                        background-clip: text;
                        -webkit-text-fill-color: transparent;
                        font-weight: 800;
                    }
                    h2 {
                        font-size: 2rem;
                        margin-bottom: 1rem;
                        color: #f8fafc;
                    }
                    p {
                        font-size: 1.1rem;
                        line-height: 1.6;
                        color: #94a3b8;
                        margin-bottom: 2rem;
                    }
                    a {
                        display: inline-block;
                        padding: 0.75rem 1.5rem;
                        background: linear-gradient(to right, #60a5fa, #a78bfa);
                        color: white;
                        text-decoration: none;
                        border-radius: 9999px;
                        font-weight: 600;
                        transition: transform 0.2s;
                    }
                    a:hover {
                        transform: translateY(-2px);
                        opacity: 0.9;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>404</h1>
                    <h2>Page Not Found</h2>
                    <p>The page you are looking for doesn't exist or has been moved.</p>
                    <a href="/">Return Home</a>
                </div>
            </body>
            </html>
            EOF_HTML_404

            sudo chmod 755 /app
            sudo chmod -R 755 /app/uploads /app/public
            sudo chown -R 1001:1001 /app/uploads /app/public

            echo "Clearing port conflicts..."
            for port in 3000 3500 5173; do
              (sudo fuser -k $port/tcp || true) 2>/dev/null
            done

            echo "Cleaning up old proxy containers..."
            docker stop nginx-proxy nginx-proxy-acme || true
            docker rm nginx-proxy nginx-proxy-acme || true

            echo "Deploying..."

            # 2. Deploy new version
            if ! ./docker-compose -f docker-compose.prod.yml up -d --remove-orphans; then
              echo "Docker Compose Up Failed!"
              ROLLBACK_NEEDED=true
            fi

            # 3. Health Check / Verification Loop
            echo "Verifying deployment health..."
            HEALTHY=false
            if [ "$ROLLBACK_NEEDED" != true ]; then
                for i in {1..12}; do # Wait up to 60 seconds (12 * 5s)
                  # Check if Client (3000) and Backend (3500) serve content (ignoring 404s/500s for a moment, just check connectivity)
                  if curl -s -f http://127.0.0.1:3000 > /dev/null && curl -s -f http://127.0.0.1:3500 > /dev/null; then
                    HEALTHY=true
                    echo "Health check passed!"
                    break
                  fi
                  echo "Waiting for services to be healthy... ($i/12)"
                  sleep 5
                done
            fi

            if [ "$HEALTHY" = false ]; then
              echo "Health check failed after 60 seconds!"
              ROLLBACK_NEEDED=true
            fi

            # 4. Rollback Logic
            if [ "$ROLLBACK_NEEDED" = true ]; then
              echo "CRITICAL: Deployment failed. Initiating Rollback..."
              if [ "$BACKUP_EXISTS" = true ]; then
                mv docker-compose.prod.yml.bak docker-compose.prod.yml
                mv .env.bak .env
                echo "Restoring last stable configuration..."
                ./docker-compose -f docker-compose.prod.yml up -d
                echo "Rollback complete. Previous version restored."
                exit 1 # Fail the pipeline
              else
                echo "No backup found! Cannot rollback."
                exit 1
              fi
            else
                 # 5. Cleanup Backups (Success Path)
                 if [ -f docker-compose.prod.yml.bak ]; then
                     rm -f docker-compose.prod.yml.bak .env.bak
                 fi
            fi

            echo "Cleaning up..."
            rm docker-compose
            docker image prune -af

            echo "Deployment successful! Files are in ~/app"
