name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Repository Name
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and Push Images
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/backend:latest
            ghcr.io/${{ env.REPO_LOWER }}/backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Client
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/client:latest
            ghcr.io/${{ env.REPO_LOWER }}/client:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_IMAGE_URL=${{ secrets.NEXT_PUBLIC_IMAGE_URL }}
            NEXT_PUBLIC_VERIFF_API_KEY=${{ secrets.NEXT_PUBLIC_VERIFF_API_KEY }}
            NEXT_PUBLIC_PRODUCT_ID=${{ secrets.NEXT_PUBLIC_PRODUCT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Admin
        uses: docker/build-push-action@v5
        with:
          context: ./admin
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/admin:latest
            ghcr.io/${{ env.REPO_LOWER }}/admin:${{ github.sha }}
          build-args: |
            VITE_APP_API_URL=${{ secrets.VITE_APP_API_URL }}
            VITE_SERVER_URI=${{ secrets.VITE_SERVER_URI }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "placeholder"
          if_key_exists: replace
          config: |
            Host production
              HostName ${{ secrets.SSH_HOST }}
              User ${{ secrets.SSH_USER }}
              Port ${{ secrets.SSH_PORT || 22 }}
              StrictHostKeyChecking no

      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            mkdir -p /app
            cd /app

            # Variables
            LOGIN_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            LOGIN_USER="${{ github.actor }}"
            IMG_TAG="${{ github.sha }}"
            REPO="${{ env.REPO_LOWER }}"

            echo "Logging into GHCR..."
            echo "$LOGIN_TOKEN" | docker login ghcr.io -u "$LOGIN_USER" --password-stdin

            echo "Installing Standalone Docker Compose V2..."
            curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 -o docker-compose
            chmod +x docker-compose

            echo "Generating Final Port-Optimized docker-compose.prod.yml..."
            cat <<EOF > docker-compose.prod.yml
            services:
              # Nginx Proxy: Handles Port 80/443 Traffic
              nginx-proxy:
                image: nginxproxy/nginx-proxy
                container_name: nginx-proxy
                restart: always
                ports:
                  - "80:80"
                  - "443:443"
                environment:
                  # DEFAULT_HOST: Traffic to IP/Port 80 goes to Client
                  - DEFAULT_HOST=gtoarcade.com
                volumes:
                  - certs:/etc/nginx/certs
                  - vhost:/etc/nginx/vhost.d
                  - html:/usr/share/nginx/html
                  - /var/run/docker.sock:/tmp/docker.sock:ro
                deploy:
                  resources:
                    limits:
                      memory: 128M

              # SSL Companion: Links to nginx-proxy to prevent restart loop
              acme-companion:
                image: nginxproxy/acme-companion
                container_name: nginx-proxy-acme
                restart: always
                volumes:
                  - /var/run/docker.sock:/var/run/docker.sock:ro
                  - acme:/etc/acme.sh
                  - certs:/etc/nginx/certs:rw
                  - vhost:/etc/nginx/vhost.d
                  - html:/usr/share/nginx/html
                environment:
                  - DEFAULT_EMAIL=\${ADMIN_EMAIL}
                  - NGINX_PROXY_CONTAINER=nginx-proxy
                depends_on:
                  - nginx-proxy
                deploy:
                  resources:
                    limits:
                      memory: 128M

              # Backend: Served on Port 3000 + api.gtoarcade.com
              backend:
                image: ghcr.io/$REPO/backend:$IMG_TAG
                restart: always
                environment:
                  - NODE_ENV=production
                  - VIRTUAL_HOST=api.gtoarcade.com
                  - LETSENCRYPT_HOST=api.gtoarcade.com
                  - VIRTUAL_PORT=3000
                  - PORT=3000
                  - MONGODB_URI=\${MONGODB_URI}
                  - ORIGINS=\${ORIGINS}
                  - DOMAIN=\${DOMAIN}
                  - EXPRESS_SESSION_SECRET=\${EXPRESS_SESSION_SECRET}
                  - REFRESH_TOKEN_SECRET=\${REFRESH_TOKEN_SECRET}
                  - ACCESS_TOKEN_SECRET=\${ACCESS_TOKEN_SECRET}
                  - EZTEXTING_API_KEY=\${EZTEXTING_API_KEY}
                  - EZTEXTING_API_SECRET=\${EZTEXTING_API_SECRET}
                  - SMTP_USER=\${SMTP_USER}
                  - SMTP_PASS=\${SMTP_PASS}
                  - SMTP_PORT=\${SMTP_PORT}
                  - SMTP_HOST=\${SMTP_HOST}
                  - ACCESS_TOKEN_EXPIRY=\${ACCESS_TOKEN_EXPIRY}
                  - REFRESH_TOKEN_EXPIRY=\${REFRESH_TOKEN_EXPIRY}
                  - GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID}
                  - GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET}
                  - GOOGLE_CLIENT_CALLBACK_URI=\${GOOGLE_CLIENT_CALLBACK_URI}
                  - CLIENT_SSO_REDIRECT_URL=\${CLIENT_SSO_REDIRECT_URL}
                  - FORGOT_PASSWORD_REDIRECT_URL=\${FORGOT_PASSWORD_REDIRECT_URL}
                  - CLIENT_URL=\${CLIENT_URL}
                  - WEBHOOK_CALLBACK_URL=\${WEBHOOK_CALLBACK_URL}
                  - PLISIO_API_KEY=\${PLISIO_API_KEY}
                  - SOAP_API_KEY=\${SOAP_API_KEY}
                  - SOAP_WEBHOOK_SECRET=\${SOAP_WEBHOOK_SECRET}
                  - SOAP_RETURN_URL=\${SOAP_RETURN_URL}
                  - ADMIN_EMAIL=\${ADMIN_EMAIL}
                  - NOWPAYMENTS_API_KEY=\${NOWPAYMENTS_API_KEY}
                  - TWILIO_MESSAGING_SERVICE_SID=\${TWILIO_MESSAGING_SERVICE_SID}
                  - TWILIO_PHONE_NUMBER=\${TWILIO_PHONE_NUMBER}
                  - TWILIO_AUTH_TOKEN=\${TWILIO_AUTH_TOKEN}
                  - TWILIO_ACCOUNT_SID=\${TWILIO_ACCOUNT_SID}
                  - GOAT_PAYMENTS_USERNAME=\${GOAT_PAYMENTS_USERNAME}
                  - GOAT_PAYMENTS_PASSWORD=\${GOAT_PAYMENTS_PASSWORD}
                  - CENTRYOS_API_KEY=\${CENTRYOS_API_KEY}
                  - CENTRYOS_WEBHOOK_SECRET=\${CENTRYOS_WEBHOOK_SECRET}
                  - CENTRYOS_RETURN_URL=\${CENTRYOS_RETURN_URL}
                  - CENTRYOS_ACCESS_TOKEN=\${CENTRYOS_ACCESS_TOKEN}
                ports:
                  - "3000:3000"
                volumes:
                  - ./uploads:/app/uploads
                deploy:
                  resources:
                    limits:
                      cpus: '0.40'
                      memory: 512M

              # Client: Served on Port 80 (via Proxy) + gtoarcade.com
              # Internal Port is now strictly 3000.
              client:
                image: ghcr.io/$REPO/client:$IMG_TAG
                restart: always
                environment:
                  - NODE_ENV=production
                  - VIRTUAL_HOST=gtoarcade.com
                  - LETSENCRYPT_HOST=gtoarcade.com
                  - VIRTUAL_PORT=3000
                  - PORT=3000
                # No external port mapping needed, Proxy handles Port 80
                deploy:
                  resources:
                    limits:
                      cpus: '0.40'
                      memory: 1024M

              # Admin: Served on Port 5173 + admin.gtoarcade.com
              admin:
                image: ghcr.io/$REPO/admin:$IMG_TAG
                restart: always
                environment:
                  - VIRTUAL_HOST=admin.gtoarcade.com
                  - LETSENCRYPT_HOST=admin.gtoarcade.com
                  - VIRTUAL_PORT=80
                ports:
                  - "5173:80"
                deploy:
                  resources:
                    limits:
                      cpus: '0.20'
                      memory: 256M

            volumes:
              certs:
              vhost:
              html:
              acme:
            EOF

            echo "Injecting environment variables..."
            cat <<EOF | sed 's/^[[:space:]]*//' > .env.prod
                PORT=3000
                MONGODB_URI='${{ secrets.MONGODB_URI }}'
                ORIGINS='${{ secrets.ORIGINS }}'
                DOMAIN='${{ secrets.DOMAIN }}'
                EXPRESS_SESSION_SECRET='${{ secrets.EXPRESS_SESSION_SECRET }}'
                REFRESH_TOKEN_SECRET='${{ secrets.REFRESH_TOKEN_SECRET }}'
                ACCESS_TOKEN_SECRET='${{ secrets.ACCESS_TOKEN_SECRET }}'
                EZTEXTING_API_KEY='${{ secrets.EZTEXTING_API_KEY }}'
                EZTEXTING_API_SECRET='${{ secrets.EZTEXTING_API_SECRET }}'
                SMTP_USER='${{ secrets.SMTP_USER }}'
                SMTP_PASS='${{ secrets.SMTP_PASS }}'
                SMTP_PORT='${{ secrets.SMTP_PORT }}'
                SMTP_HOST='${{ secrets.SMTP_HOST }}'
                ACCESS_TOKEN_EXPIRY='${{ secrets.ACCESS_TOKEN_EXPIRY }}'
                REFRESH_TOKEN_EXPIRY='${{ secrets.REFRESH_TOKEN_EXPIRY }}'
                GOOGLE_CLIENT_ID='${{ secrets.GOOGLE_CLIENT_ID }}'
                GOOGLE_CLIENT_SECRET='${{ secrets.GOOGLE_CLIENT_SECRET }}'
                GOOGLE_CLIENT_CALLBACK_URI='${{ secrets.GOOGLE_CLIENT_CALLBACK_URI }}'
                CLIENT_SSO_REDIRECT_URL='${{ secrets.CLIENT_SSO_REDIRECT_URL }}'
                FORGOT_PASSWORD_REDIRECT_URL='${{ secrets.FORGOT_PASSWORD_REDIRECT_URL }}'
                CLIENT_URL='${{ secrets.CLIENT_URL }}'
                WEBHOOK_CALLBACK_URL='${{ secrets.WEBHOOK_CALLBACK_URL }}'
                PLISIO_API_KEY='${{ secrets.PLISIO_API_KEY }}'
                SOAP_API_KEY='${{ secrets.SOAP_API_KEY }}'
                SOAP_WEBHOOK_SECRET='${{ secrets.SOAP_WEBHOOK_SECRET }}'
                SOAP_RETURN_URL='${{ secrets.SOAP_RETURN_URL }}'
                ADMIN_EMAIL='${{ secrets.ADMIN_EMAIL }}'
                NOWPAYMENTS_API_KEY='${{ secrets.NOWPAYMENTS_API_KEY }}'
                TWILIO_MESSAGING_SERVICE_SID='${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}'
                TWILIO_PHONE_NUMBER='${{ secrets.TWILIO_PHONE_NUMBER }}'
                TWILIO_AUTH_TOKEN='${{ secrets.TWILIO_AUTH_TOKEN }}'
                TWILIO_ACCOUNT_SID='${{ secrets.TWILIO_ACCOUNT_SID }}'
                GOAT_PAYMENTS_USERNAME='${{ secrets.GOAT_PAYMENTS_USERNAME }}'
                GOAT_PAYMENTS_PASSWORD='${{ secrets.GOAT_PAYMENTS_PASSWORD }}'
                CENTRYOS_API_KEY='${{ secrets.CENTRYOS_API_KEY }}'
                CENTRYOS_WEBHOOK_SECRET='${{ secrets.CENTRYOS_WEBHOOK_SECRET }}'
                CENTRYOS_RETURN_URL='${{ secrets.CENTRYOS_RETURN_URL }}'
                CENTRYOS_ACCESS_TOKEN='${{ secrets.CENTRYOS_ACCESS_TOKEN }}'
            EOF

            echo "Pulling images..."
            ./docker-compose -f docker-compose.prod.yml pull

            echo "Clearing port conflicts..."
            (sudo fuser -k 80/tcp || true) 2>/dev/null
            (sudo fuser -k 443/tcp || true) 2>/dev/null
            (sudo fuser -k 3000/tcp || true) 2>/dev/null
            (sudo fuser -k 5173/tcp || true) 2>/dev/null

            echo "Deploying with Correct Port Mapping..."
            ./docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --force-recreate --remove-orphans

            echo "Cleaning up..."
            rm docker-compose
            docker image prune -af

            echo "Deployment successful!"
