services:
  # Backend API Server
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3000
      - MONGODB_URI=${MONGODB_URI}
      - ORIGINS=${ORIGINS}
      - DOMAIN=${DOMAIN}
      - EXPRESS_SESSION_SECRET=${EXPRESS_SESSION_SECRET}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}
      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET}
      - EZTEXTING_API_KEY=${EZTEXTING_API_KEY}
      - EZTEXTING_API_SECRET=${EZTEXTING_API_SECRET}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_HOST=${SMTP_HOST}
      - ACCESS_TOKEN_EXPIRY=${ACCESS_TOKEN_EXPIRY}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CLIENT_CALLBACK_URI=${GOOGLE_CLIENT_CALLBACK_URI}
      - CLIENT_SSO_REDIRECT_URL=${CLIENT_SSO_REDIRECT_URL}
      - FORGOT_PASSWORD_REDIRECT_URL=${FORGOT_PASSWORD_REDIRECT_URL}
      - CLIENT_URL=${CLIENT_URL}
      - WEBHOOK_CALLBACK_URL=${WEBHOOK_CALLBACK_URL}
      - PLISIO_API_KEY=${PLISIO_API_KEY}
      - SOAP_API_KEY=${SOAP_API_KEY}
      - SOAP_WEBHOOK_SECRET=${SOAP_WEBHOOK_SECRET}
      - SOAP_RETURN_URL=${SOAP_RETURN_URL}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - NOWPAYMENTS_API_KEY=${NOWPAYMENTS_API_KEY}
      - TWILIO_MESSAGING_SERVICE_SID=${TWILIO_MESSAGING_SERVICE_SID}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - GOAT_PAYMENTS_USERNAME=${GOAT_PAYMENTS_USERNAME}
      - GOAT_PAYMENTS_PASSWORD=${GOAT_PAYMENTS_PASSWORD}
      - CENTRYOS_API_KEY=${CENTRYOS_API_KEY}
      - CENTRYOS_WEBHOOK_SECRET=${CENTRYOS_WEBHOOK_SECRET}
      - CENTRYOS_RETURN_URL=${CENTRYOS_RETURN_URL}
      - CENTRYOS_ACCESS_TOKEN=${CENTRYOS_ACCESS_TOKEN}
    ports:
      - "3000:3000"
    volumes:
      - ./uploads:/app/uploads
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Next.js Client
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_IMAGE_URL=${NEXT_PUBLIC_IMAGE_URL}
        - NEXT_PUBLIC_VERIFF_API_KEY=${NEXT_PUBLIC_VERIFF_API_KEY}
        - NEXT_PUBLIC_PRODUCT_ID=${NEXT_PUBLIC_PRODUCT_ID}
    restart: always
    environment:
      - NODE_ENV=production
    ports:
      - "5173:3001"
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 512M

  # Admin Dashboard
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
      args:
        - VITE_APP_API_URL=${VITE_APP_API_URL}
        - VITE_SERVER_URI=${VITE_SERVER_URI}
    restart: always
    ports:
      - "80:80"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.10'
          memory: 128M

# Uptime: Automatic restarts and resource limits prevent one service from crashing the host.
# Optimization: Explicit CPU and RAM limits ensure efficient resource usage.
# Volumes: persistent storage for backend uploads managed with UID 1001 permissions.
