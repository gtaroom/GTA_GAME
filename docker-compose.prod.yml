services:
  # Database (Exposed to Host Port 27017)
  mongodb:
    image: mongo:latest
    container_name: mongodb
    command: mongod --auth --wiredTigerCacheSizeGB 0.5 --quiet
    restart: always
    ports:
      - "127.0.0.1:27017:27017" # Restrict to localhost only (secure)
    volumes:
      - mongodb_data:/data/db
    deploy:
      resources:
        limits:
          cpus: '0.60'
          memory: 1024M
        reservations:
          cpus: '0.20'
          memory: 512M

  # Backend API Server
  backend:
    image: ghcr.io/gtaroom/gta_game/backend:latest
    restart: always
    env_file: .env
    environment:
      - NODE_ENV=production
      - PORT=3500
      - UV_THREADPOOL_SIZE=4
    ports:
      - "127.0.0.1:3500:3500"
    volumes:
      - ./uploads:/app/public/uploads
      - ./public/games:/app/public/games
      - ./public/game:/app/public/game
      - ./public/GeoLite2-City.mmdb:/app/public/GeoLite2-City.mmdb
    deploy:
      resources:
        limits:
          cpus: '0.80'
          memory: 1536M
        reservations:
          cpus: '0.30'
          memory: 512M

  # Next.js Client
  client:
    image: ghcr.io/gtaroom/gta_game/client:latest
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3000
    ports:
      - "127.0.0.1:3000:3000"
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1024M
        reservations:
          cpus: '0.15'
          memory: 256M

  # Admin Dashboard
  admin:
    image: ghcr.io/gtaroom/gta_game/admin:latest
    restart: always
    ports:
      - "127.0.0.1:5173:80"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 128M

volumes:
  mongodb_data:

# Uptime: Automatic restarts and resource limits prevent one service from crashing the host.
# Optimization: Explicit CPU and RAM limits ensure efficient resource usage.
# Volumes: persistent storage for backend uploads managed with UID 1001 permissions.
